#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

BUILD_DIR=$1
CACHE_DIR=$2

# exit when any command fails
set -e

BINARY_URL="https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-2/wkhtmltox_0.12.6.1-2.jammy_amd64.deb"
BINARY_FILENAME=$(basename $BINARY_URL)
BINARY_OUTPUT_PATH=$BUILD_DIR/bin

WORKING_DIR=$CACHE_DIR/heroku-buildpack-wkhtmltopdf
DOWNLOAD_FILENAME=$WORKING_DIR/$BINARY_FILENAME
EXTRACT_DIR=$WORKING_DIR/output

function info() {
  echo "\n-----> $*\n"
}

if [ ! -d $WORKING_DIR ]; then
  mkdir -p $WORKING_DIR

  echo $(ls "$WORKING_DIR")

  info "Fetching binary from $BINARY_URL"

  echo "Downloading to $DOWNLOAD_FILENAME"
  wget $BINARY_URL -qcO $DOWNLOAD_FILENAME

  echo "Extracting to $EXTRACT_DIR"
  dpkg -x $DOWNLOAD_FILENAME $EXTRACT_DIR

  echo 'Cleaning up download, preserving extracted version for future builds'
  rm -f $DOWNLOAD_FILENAME
else
  info 'Using cached binary'
  echo 'If cache is corrupt, clear it by running `heroku builds:cache:purge`'
fi

info 'Installing'

if ( !-d $BINARY_OUTPUT_PATH ); then
  mkdir -p $BINARY_OUTPUT_PATH
fi

echo "Copying files to $BINARY_OUTPUT_PATH"
cp $EXTRACT_DIR/usr/local/bin/* $BINARY_OUTPUT_PATH

echo 'wkhtmltopdf is successfully installed'
